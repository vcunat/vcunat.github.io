<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Fractal Image Compressor: modules/stdDomains.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.8 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>modules/stdDomains.cpp</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include "stdDomains.h"</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include "../fileUtil.h"</span>
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="keyword">enum</span> { MinDomSize=8, MinRngSize=4 };
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="keyword">using namespace </span>std;
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 
<a name="l00010"></a>00010 <span class="keyword">namespace </span>NOSPACE {
<a name="l00011"></a>00011     <span class="keyword">using namespace </span>MatrixWalkers;
<a name="l00014"></a><a class="code" href="classMStdDomains.html#568d07114f60c323fb388017979cfac5">00014</a>     <span class="keywordtype">void</span> <a class="code" href="classMStdDomains.html#568d07114f60c323fb388017979cfac5" title="Performs a simple 50%^2 image shrink (dimensions belong to the destination).">shrinkToHalf</a>( CSMatrix src, SMatrix dest, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height ) {
<a name="l00015"></a>00015         <a class="code" href="namespaceMatrixWalkers.html#3292f064e443c2a947d2cc73c9805918" title="Iterates two matrix iterators and performs an action.">walkOperate</a>( <a class="code" href="structMatrixWalkers_1_1Checked.html" title="Checked_ iterator for a rectangle in a matrix, no rotation.">Checked&lt;SReal&gt;</a>(dest,<a class="code" href="structBlock.html" title="A simple structure representing a rectangle.">Block</a>(0,0,width,height))
<a name="l00016"></a>00016         , <a class="code" href="structMatrixWalkers_1_1HalfShrinker.html" title="Matrix iterator performing a 2x2 to 1 shrink.">HalfShrinker&lt;const SReal&gt;</a>(src), <a class="code" href="structMatrixWalkers_1_1ReverseAssigner.html" title="A simple assigning operator - assigns its second argument into the first one.">ReverseAssigner</a>() );
<a name="l00017"></a>00017     }
<a name="l00020"></a><a class="code" href="classMStdDomains.html#a787de930afda6e9755747054f561d19">00020</a>     <span class="keywordtype">void</span> <a class="code" href="classMStdDomains.html#a787de930afda6e9755747054f561d19" title="Performs a simple 33%x66% image horizontal shrink (dimensions belong to the destination)...">shrinkHorizontally</a>( CSMatrix src, SMatrix dest, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height ) {
<a name="l00021"></a>00021         <a class="code" href="namespaceMatrixWalkers.html#3292f064e443c2a947d2cc73c9805918" title="Iterates two matrix iterators and performs an action.">walkOperate</a>( <a class="code" href="structMatrixWalkers_1_1Checked.html" title="Checked_ iterator for a rectangle in a matrix, no rotation.">Checked&lt;SReal&gt;</a>(dest,<a class="code" href="structBlock.html" title="A simple structure representing a rectangle.">Block</a>(0,0,width,height))
<a name="l00022"></a>00022         , <a class="code" href="structMatrixWalkers_1_1HorizShrinker.html" title="Matrix iterator performing a 3x3 to 1x2 shrink.">HorizShrinker&lt;const SReal&gt;</a>(src), <a class="code" href="structMatrixWalkers_1_1ReverseAssigner.html" title="A simple assigning operator - assigns its second argument into the first one.">ReverseAssigner</a>() );
<a name="l00023"></a>00023     }
<a name="l00026"></a><a class="code" href="classMStdDomains.html#87e2dc950f5d4e3726d7d2e2570da9ea">00026</a>     <span class="keywordtype">void</span> <a class="code" href="classMStdDomains.html#87e2dc950f5d4e3726d7d2e2570da9ea" title="Performs a simple 66%x33% image vertical shrink (dimensions belong to the destination)...">shrinkVertically</a>( CSMatrix src, SMatrix dest, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height ) {
<a name="l00027"></a>00027         <a class="code" href="namespaceMatrixWalkers.html#3292f064e443c2a947d2cc73c9805918" title="Iterates two matrix iterators and performs an action.">walkOperate</a>( <a class="code" href="structMatrixWalkers_1_1Checked.html" title="Checked_ iterator for a rectangle in a matrix, no rotation.">Checked&lt;SReal&gt;</a>(dest,<a class="code" href="structBlock.html" title="A simple structure representing a rectangle.">Block</a>(0,0,width,height))
<a name="l00028"></a>00028         , <a class="code" href="structMatrixWalkers_1_1VertShrinker.html" title="Matrix iterator performing a 3x3 to 2x1 shrink.">VertShrinker&lt;const SReal&gt;</a>(src), <a class="code" href="structMatrixWalkers_1_1ReverseAssigner.html" title="A simple assigning operator - assigns its second argument into the first one.">ReverseAssigner</a>() );
<a name="l00029"></a>00029     }
<a name="l00033"></a><a class="code" href="classMStdDomains.html#2b725d60d2760e92a6c0c6179a732ad1">00033</a>     <span class="keywordtype">void</span> <a class="code" href="classMStdDomains.html#2b725d60d2760e92a6c0c6179a732ad1" title="Performs 50% shrink with 45-degree anticlockwise rotation (side - the length of the...">shrinkToDiamond</a>( CSMatrix src, SMatrix dest, <span class="keywordtype">int</span> side ) {
<a name="l00034"></a>00034         <a class="code" href="namespaceMatrixWalkers.html#3292f064e443c2a947d2cc73c9805918" title="Iterates two matrix iterators and performs an action.">walkOperate</a>( <a class="code" href="structMatrixWalkers_1_1Checked.html" title="Checked_ iterator for a rectangle in a matrix, no rotation.">Checked&lt;SReal&gt;</a>(dest,<a class="code" href="structBlock.html" title="A simple structure representing a rectangle.">Block</a>(0,0,side,side))
<a name="l00035"></a>00035         , <a class="code" href="structMatrixWalkers_1_1DiamShrinker.html" title="Matrix iterator performing a shrink of a diamond (rotated sub-square) into a square...">DiamShrinker&lt;const SReal&gt;</a>(src,side), <a class="code" href="structMatrixWalkers_1_1ReverseAssigner.html" title="A simple assigning operator - assigns its second argument into the first one.">ReverseAssigner</a>() );
<a name="l00036"></a>00036     }<span class="comment">// shrinkToDiamond</span>
<a name="l00037"></a>00037 }
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="keyword">namespace </span>NOSPACE {
<a name="l00042"></a>00042     <span class="keyword">struct </span>PoolTypeLevelComparator {
<a name="l00043"></a>00043         <span class="keyword">typedef</span> MStdDomains::Pool Pool;
<a name="l00044"></a>00044         <span class="keywordtype">bool</span> operator()(<span class="keyword">const</span> Pool &amp;a,<span class="keyword">const</span> Pool &amp;b) {
<a name="l00045"></a>00045             <span class="keywordflow">if</span> (a.type!=b.type)
<a name="l00046"></a>00046                 <span class="keywordflow">return</span> a.type&lt;b.type;
<a name="l00047"></a>00047             <span class="keywordflow">else</span>
<a name="l00048"></a>00048                 <span class="keywordflow">return</span> a.level&lt;b.level;
<a name="l00049"></a>00049         }
<a name="l00050"></a>00050     };
<a name="l00051"></a>00051     <span class="comment">/* All sizes are unzoomed */</span>
<a name="l00052"></a>00052     <span class="keyword">inline</span> <span class="keyword">static</span> <span class="keywordtype">int</span> minSizeNeededForDiamond() 
<a name="l00053"></a>00053         { <span class="keywordflow">return</span> 2*MinDomSize-1; }
<a name="l00054"></a>00054     <span class="keyword">inline</span> <span class="keyword">static</span> <span class="keywordtype">int</span> getDiamondSize(<span class="keywordtype">int</span> fromSize)
<a name="l00055"></a>00055         { <span class="keywordflow">return</span> fromSize&lt;minSizeNeededForDiamond() ? 0 : fromSize/2; }
<a name="l00056"></a>00056     <span class="keyword">inline</span> <span class="keyword">static</span> <span class="keywordtype">int</span> getDiamondShift(<span class="keywordtype">int</span> fromSize) 
<a name="l00057"></a>00057         { <span class="keywordflow">return</span> ( getDiamondSize(fromSize) - MinRngSize + 1 )*2; }
<a name="l00058"></a>00058 }
<a name="l00059"></a><a class="code" href="classMStdDomains.html#68379e2daee9a40e8595903e8266ae0f">00059</a> <span class="keywordtype">void</span> <a class="code" href="classMStdDomains.html#68379e2daee9a40e8595903e8266ae0f" title="Initializes the pools for given PlaneBlock, assumes settings are OK.">MStdDomains::initPools</a>(<span class="keyword">const</span> PlaneBlock &amp;planeBlock) {
<a name="l00060"></a>00060     <a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a>=   planeBlock.settings-&gt;zoom;
<a name="l00061"></a>00061     <a class="code" href="classMStdDomains.html#84803ad7d7d02d389d7581a8b8583421" title="Width of the original image (not zoomed).">width</a>=  <a class="code" href="util_8h.html#f5d4f5e275aa85b08f39bccb0822aac7" title="Returns i/2^bits.">rShift</a>( planeBlock.width, <a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a> );
<a name="l00062"></a>00062     <a class="code" href="classMStdDomains.html#898ee31d4b2fea01cbb300a09932e4bd" title="Height of the original image (not zoomed).">height</a>= <a class="code" href="util_8h.html#f5d4f5e275aa85b08f39bccb0822aac7" title="Returns i/2^bits.">rShift</a>( planeBlock.height, <a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a> );
<a name="l00063"></a>00063 <span class="comment">//  checks some things</span>
<a name="l00064"></a>00064     ASSERT( <a class="code" href="classMStdDomains.html#84803ad7d7d02d389d7581a8b8583421" title="Width of the original image (not zoomed).">width</a>&gt;0 &amp;&amp; <a class="code" href="classMStdDomains.html#898ee31d4b2fea01cbb300a09932e4bd" title="Height of the original image (not zoomed).">height</a>&gt;0 &amp;&amp; <span class="keyword">this</span> &amp;&amp; <a class="code" href="classModule.html#05a8665b709707811945fa29714c2e00" title="The current setting values of this Module.">settings</a> &amp;&amp; <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.empty() );
<a name="l00065"></a>00065     <span class="keywordflow">if</span> ( min(<a class="code" href="classMStdDomains.html#84803ad7d7d02d389d7581a8b8583421" title="Width of the original image (not zoomed).">width</a>,<a class="code" href="classMStdDomains.html#898ee31d4b2fea01cbb300a09932e4bd" title="Height of the original image (not zoomed).">height</a>)/2 &lt; MinDomSize )
<a name="l00066"></a>00066     <span class="comment">//  no domains (too small)</span>
<a name="l00067"></a>00067         <span class="keywordflow">return</span>;
<a name="l00068"></a>00068 <span class="comment">//  create the first set of domain pools for standard, horizontal and vertical domains</span>
<a name="l00069"></a>00069     <span class="keywordflow">if</span> ( <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(DomPortion_Standard) )
<a name="l00070"></a>00070         <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.push_back(Pool( <a class="code" href="classMStdDomains.html#84803ad7d7d02d389d7581a8b8583421" title="Width of the original image (not zoomed).">width</a>/2, <a class="code" href="classMStdDomains.html#898ee31d4b2fea01cbb300a09932e4bd" title="Height of the original image (not zoomed).">height</a>/2, DomPortion_Standard, 1, 0.25, <a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a> ));
<a name="l00071"></a>00071     <span class="keywordflow">if</span> ( <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(DomPortion_Horiz) &amp;&amp; <a class="code" href="classMStdDomains.html#84803ad7d7d02d389d7581a8b8583421" title="Width of the original image (not zoomed).">width</a>/3&gt;=MinDomSize )
<a name="l00072"></a>00072         <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.push_back(Pool( <a class="code" href="classMStdDomains.html#84803ad7d7d02d389d7581a8b8583421" title="Width of the original image (not zoomed).">width</a>/3, <a class="code" href="classMStdDomains.html#898ee31d4b2fea01cbb300a09932e4bd" title="Height of the original image (not zoomed).">height</a>/3*2, DomPortion_Horiz, 1, 2.0/9.0, <a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a> ));
<a name="l00073"></a>00073     <span class="keywordflow">if</span> ( <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(DomPortion_Vert) &amp;&amp; <a class="code" href="classMStdDomains.html#898ee31d4b2fea01cbb300a09932e4bd" title="Height of the original image (not zoomed).">height</a>/3&gt;=MinDomSize )
<a name="l00074"></a>00074         <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.push_back(Pool( <a class="code" href="classMStdDomains.html#84803ad7d7d02d389d7581a8b8583421" title="Width of the original image (not zoomed).">width</a>/3*2, <a class="code" href="classMStdDomains.html#898ee31d4b2fea01cbb300a09932e4bd" title="Height of the original image (not zoomed).">height</a>/3, DomPortion_Vert, 1, 2.0/9.0, <a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a> ));
<a name="l00075"></a>00075 <span class="comment">//  create the first set of domain pools for diamond domains</span>
<a name="l00076"></a>00076     <span class="keywordflow">if</span> ( <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(DomPortion_Diamond) ) {
<a name="l00077"></a>00077     <span class="comment">//  get longer and shorter dimension</span>
<a name="l00078"></a>00078         <span class="keywordtype">int</span> shorter= min(<a class="code" href="classMStdDomains.html#84803ad7d7d02d389d7581a8b8583421" title="Width of the original image (not zoomed).">width</a>,<a class="code" href="classMStdDomains.html#898ee31d4b2fea01cbb300a09932e4bd" title="Height of the original image (not zoomed).">height</a>);
<a name="l00079"></a>00079         <span class="keywordtype">int</span> shift= getDiamondShift(shorter);
<a name="l00080"></a>00080     <span class="comment">//  generate the pool sizes</span>
<a name="l00081"></a>00081         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> longer=max(<a class="code" href="classMStdDomains.html#84803ad7d7d02d389d7581a8b8583421" title="Width of the original image (not zoomed).">width</a>,<a class="code" href="classMStdDomains.html#898ee31d4b2fea01cbb300a09932e4bd" title="Height of the original image (not zoomed).">height</a>); longer&gt;minSizeNeededForDiamond(); longer-=shift) {
<a name="l00082"></a>00082             <span class="keywordtype">int</span> side= getDiamondSize( min(longer,shorter) );
<a name="l00083"></a>00083             ASSERT(side&gt;=0);
<a name="l00084"></a>00084             <span class="keywordflow">if</span> (side)
<a name="l00085"></a>00085                 <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.push_back(Pool( side, side, DomPortion_Diamond, 1, 0.5, <a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a> ));
<a name="l00086"></a>00086             <span class="keywordflow">else</span>
<a name="l00087"></a>00087                 <span class="keywordflow">break</span>;
<a name="l00088"></a>00088         }
<a name="l00089"></a>00089     }
<a name="l00090"></a>00090 <span class="comment">//  if allowed, create more downscaled domains (at most 256 pools)</span>
<a name="l00091"></a>00091     <span class="keywordflow">if</span> ( <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(MultiDownScaling) )
<a name="l00092"></a>00092         <span class="keywordflow">for</span> (Uint i=0; i&lt;<a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.size() &amp;&amp; i&lt;256; ++i) {
<a name="l00093"></a>00093             <span class="keyword">const</span> Pool &amp;pool= <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>[i];
<a name="l00094"></a>00094         <span class="comment">//  compute new dimensions and add the pool if it's big enough  </span>
<a name="l00095"></a>00095             <span class="keywordtype">int</span> w= rShift&lt;int&gt;(pool.width,<a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a>+1);
<a name="l00096"></a>00096             <span class="keywordtype">int</span> h= rShift&lt;int&gt;(pool.height,<a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a>+1);
<a name="l00097"></a>00097             <span class="keywordtype">float</span> cf= ldexp(pool.contrFactor,-2);
<a name="l00098"></a>00098             <span class="keywordflow">if</span> ( min(w,h) &gt;= MinDomSize )
<a name="l00099"></a>00099                 <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.push_back( Pool( w, h, pool.type, pool.level+1, cf, <a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a> ) );
<a name="l00100"></a>00100         }
<a name="l00101"></a>00101 <span class="comment">//  sort the pools according to their types and levels (stable so the diamonds can't be swapped)</span>
<a name="l00102"></a>00102     stable_sort( <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.begin(), <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.end(), PoolTypeLevelComparator() );
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="keyword">namespace </span>NOSPACE {
<a name="l00106"></a>00106     <span class="keyword">typedef</span> MStdDomains::PoolList::const_iterator PoolIt;
<a name="l00108"></a>00108     <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">bool</span> halfShrinkOK(PoolIt src,PoolIt dest,<span class="keywordtype">int</span> zoom) {
<a name="l00109"></a>00109         <span class="keywordflow">return</span> src-&gt;level+1 == dest-&gt;level &amp;&amp; src-&gt;type == dest-&gt;type
<a name="l00110"></a>00110             &amp;&amp; rShift&lt;int&gt;(src-&gt;width,zoom+1) == rShift&lt;int&gt;(dest-&gt;width,zoom)
<a name="l00111"></a>00111             &amp;&amp; rShift&lt;int&gt;(src-&gt;height,zoom+1) == rShift&lt;int&gt;(dest-&gt;height,zoom);
<a name="l00112"></a>00112     }
<a name="l00113"></a>00113 }
<a name="l00114"></a><a class="code" href="classMStdDomains.html#b211afb5c3646367540f143d65157a2f">00114</a> <span class="keywordtype">void</span> <a class="code" href="classMStdDomains.html#b211afb5c3646367540f143d65157a2f" title="Prepares domains in already initialized pools (and invalidates summers, etc. ).">MStdDomains::fillPixelsInPools</a>(PlaneBlock &amp;planeBlock) {
<a name="l00115"></a>00115     ASSERT( !<a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.empty() ); <span class="comment">// assuming initPools has already been called</span>
<a name="l00116"></a>00116 <span class="comment">//  iterate over pool types</span>
<a name="l00117"></a>00117     PoolList::iterator end= <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.begin();
<a name="l00118"></a>00118     <span class="keywordflow">while</span> ( end != <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.end() ) {
<a name="l00119"></a>00119         PoolList::iterator begin= end;
<a name="l00120"></a>00120         <span class="keywordtype">char</span> type= begin-&gt;type;
<a name="l00121"></a>00121     <span class="comment">//  find the end of the same-pool-type block and invalidate the summers on the way</span>
<a name="l00122"></a>00122         <span class="keywordflow">while</span> ( end!=<a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.end() &amp;&amp; end-&gt;type==type ) {
<a name="l00123"></a>00123             end-&gt;summers_invalidate();
<a name="l00124"></a>00124             ++end;
<a name="l00125"></a>00125         }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     <span class="comment">//  we've got the interval, find out about the type</span>
<a name="l00128"></a>00128         <span class="keywordflow">if</span> (type!=DomPortion_Diamond) {
<a name="l00129"></a>00129         <span class="comment">//  non-diamond domains all behave similarly</span>
<a name="l00130"></a>00130             void (*shrinkProc)( CSMatrix , SMatrix , int, int );
<a name="l00131"></a>00131             <span class="keywordflow">switch</span> (type) {
<a name="l00132"></a>00132                 <span class="keywordflow">case</span> DomPortion_Standard:   shrinkProc= &amp;<a class="code" href="classMStdDomains.html#568d07114f60c323fb388017979cfac5" title="Performs a simple 50%^2 image shrink (dimensions belong to the destination).">shrinkToHalf</a>;      <span class="keywordflow">break</span>;
<a name="l00133"></a>00133                 <span class="keywordflow">case</span> DomPortion_Horiz:      shrinkProc= &amp;<a class="code" href="classMStdDomains.html#a787de930afda6e9755747054f561d19" title="Performs a simple 33%x66% image horizontal shrink (dimensions belong to the destination)...">shrinkHorizontally</a>;<span class="keywordflow">break</span>;
<a name="l00134"></a>00134                 <span class="keywordflow">case</span> DomPortion_Vert:       shrinkProc= &amp;<a class="code" href="classMStdDomains.html#87e2dc950f5d4e3726d7d2e2570da9ea" title="Performs a simple 66%x33% image vertical shrink (dimensions belong to the destination)...">shrinkVertically</a>;  <span class="keywordflow">break</span>;
<a name="l00135"></a>00135                 <span class="keywordflow">default</span>: ASSERT(<span class="keyword">false</span>), shrinkProc=0;
<a name="l00136"></a>00136             }
<a name="l00137"></a>00137         <span class="comment">//  we have the right procedure -&gt; fill the first pool</span>
<a name="l00138"></a>00138             ASSERT( begin-&gt;level == 1 );
<a name="l00139"></a>00139             shrinkProc( planeBlock.pixels, begin-&gt;pixels, begin-&gt;width, begin-&gt;height );
<a name="l00140"></a>00140         <span class="comment">//  fill the rest (in the same-type interval)</span>
<a name="l00141"></a>00141             <span class="keywordflow">while</span> (++begin != end) {
<a name="l00142"></a>00142                 ASSERT( halfShrinkOK(begin-1,begin,<a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a>) );
<a name="l00143"></a>00143                 <a class="code" href="classMStdDomains.html#568d07114f60c323fb388017979cfac5" title="Performs a simple 50%^2 image shrink (dimensions belong to the destination).">shrinkToHalf</a>( (begin-1)-&gt;pixels, begin-&gt;pixels, begin-&gt;width, begin-&gt;height );
<a name="l00144"></a>00144             }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146         } <span class="keywordflow">else</span> { <span class="comment">// handle diamond-type domains</span>
<a name="l00147"></a>00147             PoolList::iterator it= begin; <span class="comment">//&lt; the currently filled domain pool</span>
<a name="l00148"></a>00148         <span class="comment">//  fill the first set of diamond-type domain pools</span>
<a name="l00149"></a>00149             <span class="keywordtype">bool</span> horiz= <a class="code" href="classMStdDomains.html#84803ad7d7d02d389d7581a8b8583421" title="Width of the original image (not zoomed).">width</a>&gt;=<a class="code" href="classMStdDomains.html#898ee31d4b2fea01cbb300a09932e4bd" title="Height of the original image (not zoomed).">height</a>;
<a name="l00150"></a>00150             <span class="keywordtype">int</span> shift= <a class="code" href="util_8h.html#580298e8968e8f95e880690a2e34b0c1" title="Returns i*2^bits.">lShift</a>( getDiamondShift(min(<a class="code" href="classMStdDomains.html#84803ad7d7d02d389d7581a8b8583421" title="Width of the original image (not zoomed).">width</a>,<a class="code" href="classMStdDomains.html#898ee31d4b2fea01cbb300a09932e4bd" title="Height of the original image (not zoomed).">height</a>)), <a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a> );
<a name="l00151"></a>00151             <span class="keywordtype">int</span> longerEnd= <a class="code" href="util_8h.html#580298e8968e8f95e880690a2e34b0c1" title="Returns i*2^bits.">lShift</a>( max(<a class="code" href="classMStdDomains.html#84803ad7d7d02d389d7581a8b8583421" title="Width of the original image (not zoomed).">width</a>,<a class="code" href="classMStdDomains.html#898ee31d4b2fea01cbb300a09932e4bd" title="Height of the original image (not zoomed).">height</a>)-minSizeNeededForDiamond(), <a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a> );
<a name="l00152"></a>00152             CSMatrix source= planeBlock.pixels; 
<a name="l00153"></a>00153             
<a name="l00154"></a>00154             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> l=0; l&lt;=longerEnd; ++it,l+=shift) {
<a name="l00155"></a>00155                 ASSERT( it!=end &amp;&amp; it-&gt;level==1 &amp;&amp; it-&gt;width==it-&gt;height );
<a name="l00156"></a>00156                 <a class="code" href="classMStdDomains.html#2b725d60d2760e92a6c0c6179a732ad1" title="Performs 50% shrink with 45-degree anticlockwise rotation (side - the length of the...">shrinkToDiamond</a>( planeBlock.pixels, it-&gt;pixels, it-&gt;width );
<a name="l00157"></a>00157                 source.shiftMatrix( (horiz?shift:0), (horiz?0:shift) );
<a name="l00158"></a>00158             }
<a name="l00159"></a>00159         <span class="comment">//  now fill the multiscaled diamond pools</span>
<a name="l00160"></a>00160             <span class="keywordflow">while</span> (it!=end) {
<a name="l00161"></a>00161             <span class="comment">//  too small pools are skipped</span>
<a name="l00162"></a>00162                 <span class="keywordflow">while</span> ( min(begin-&gt;width,begin-&gt;height) &lt; 2*MinDomSize )
<a name="l00163"></a>00163                     ++begin;
<a name="l00164"></a>00164                 ASSERT( halfShrinkOK(begin,it,<a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a>) );
<a name="l00165"></a>00165                 <a class="code" href="classMStdDomains.html#568d07114f60c323fb388017979cfac5" title="Performs a simple 50%^2 image shrink (dimensions belong to the destination).">shrinkToHalf</a>( begin-&gt;pixels, it-&gt;pixels, it-&gt;width, it-&gt;height );
<a name="l00166"></a>00166             <span class="comment">//  move on</span>
<a name="l00167"></a>00167                 ++it;
<a name="l00168"></a>00168                 ++begin;
<a name="l00169"></a>00169             }
<a name="l00170"></a>00170         }<span class="comment">// if non-diamond else diamond</span>
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="comment">//  we just handled the whole interval (of diamond or other type)</span>
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     }<span class="comment">// for (iterate over single-type intervals)</span>
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="comment">//  (cancelled) we filled all pools, let's prepare the summers</span>
<a name="l00177"></a>00177     <span class="comment">//for_each( pools, mem_fun_ref(&amp;Pool::summers_makeValid) );</span>
<a name="l00178"></a>00178 }<span class="comment">// ::fillPixelsInPools</span>
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="keyword">namespace </span>NOSPACE {
<a name="l00184"></a><a class="code" href="classMStdDomains.html#27fce970e9f1edd93ba247b68d3555c0">00184</a>     <span class="keyword">inline</span> <span class="keyword">static</span> <span class="keywordtype">int</span> bestDomainDensity( PoolIt pool, <span class="keywordtype">int</span> level, <span class="keywordtype">int</span> maxCount, <span class="keywordtype">int</span> zoom
<a name="l00185"></a>00185     , vector&lt;short&gt; &amp;result) {
<a name="l00186"></a>00186         level-= zoom;
<a name="l00187"></a>00187         ASSERT( maxCount&gt;=0 &amp;&amp; level&gt;0 &amp;&amp; zoom&gt;=0 );
<a name="l00188"></a>00188         <span class="keywordtype">int</span> wms= rShift&lt;int&gt;(pool-&gt;width,zoom) -powers[level];
<a name="l00189"></a>00189         <span class="keywordtype">int</span> hms= rShift&lt;int&gt;(pool-&gt;height,zoom) -powers[level];
<a name="l00190"></a>00190     <span class="comment">//  check whether any domain can fit and whether we should generate any more</span>
<a name="l00191"></a>00191         <span class="keywordflow">if</span> ( wms&lt;0 || hms&lt;0 || !maxCount ) {
<a name="l00192"></a>00192             result.push_back(0);
<a name="l00193"></a>00193             <span class="keywordflow">return</span> 0;
<a name="l00194"></a>00194         }
<a name="l00195"></a>00195         <span class="keywordtype">int</span> dens;
<a name="l00196"></a>00196         <span class="keywordflow">if</span> (maxCount&gt;1) {
<a name="l00197"></a>00197             Real temp= (  wms+hms+sqrt( sqr&lt;Real&gt;(wms+hms) +Real(4*wms*hms)*(maxCount-1) )  )
<a name="l00198"></a>00198                 / ( 2*(maxCount-1) );
<a name="l00199"></a>00199             dens= (int)ceil(temp);
<a name="l00200"></a>00200         } <span class="keywordflow">else</span>
<a name="l00201"></a>00201             dens= 1+max(wms,hms);
<a name="l00202"></a>00202         
<a name="l00203"></a>00203         <span class="keywordflow">if</span> (!dens)
<a name="l00204"></a>00204             dens= 1;
<a name="l00205"></a>00205         ASSERT(dens&gt;0);
<a name="l00206"></a>00206         <span class="keywordtype">int</span> count= (wms/dens+1)*(hms/dens+1);
<a name="l00207"></a>00207         ASSERT(count&lt;=maxCount);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         result.push_back(dens);
<a name="l00210"></a>00210         <span class="keywordflow">return</span> count;
<a name="l00211"></a>00211     }
<a name="l00216"></a><a class="code" href="classMStdDomains.html#a1bef878bf39ff0c3f013e926332f9c1">00216</a>     <span class="keyword">static</span> <span class="keywordtype">int</span> divideDomsInType( PoolIt begin, PoolIt end, <span class="keywordtype">int</span> maxCount, <span class="keywordtype">int</span> level
<a name="l00217"></a>00217     , <span class="keywordtype">char</span> divType, <span class="keywordtype">int</span> zoom, vector&lt;short&gt; &amp;results ) {
<a name="l00218"></a>00218         ASSERT( begin!=end &amp;&amp; divType&gt;=0 &amp;&amp; divType&lt;=2 );
<a name="l00219"></a>00219         <span class="keywordtype">int</span> scaleLevels= (end-1)-&gt;level - begin-&gt;level + 1;
<a name="l00220"></a>00220         <span class="keywordtype">int</span> genCount= 0;
<a name="l00221"></a>00221     <span class="comment">//  iterate over same-scaleLevel intervals</span>
<a name="l00222"></a>00222         for (; begin!=end; --scaleLevels) {
<a name="l00223"></a>00223             PoolIt it= begin+1;
<a name="l00224"></a>00224             <span class="keywordflow">while</span> ( it!=end &amp;&amp; it-&gt;level==begin-&gt;level )
<a name="l00225"></a>00225                 ++it;
<a name="l00226"></a>00226         <span class="comment">//  we have the same-scale interval, find out how many domains to generate for it</span>
<a name="l00227"></a>00227             <span class="keywordtype">int</span> toGenerate= divType==2
<a name="l00228"></a>00228             <span class="comment">//  half per scale level</span>
<a name="l00229"></a>00229                 ? (maxCount-genCount)/2
<a name="l00230"></a>00230             <span class="comment">//  uniform dividing or no multiscaling (then scaleLevels==1)</span>
<a name="l00231"></a>00231                 : (maxCount-genCount)/scaleLevels ;
<a name="l00232"></a>00232         <span class="comment">//  distribute it uniformly among the interval</span>
<a name="l00233"></a>00233         <span class="comment">//  (there are more than one for diamond-type only)</span>
<a name="l00234"></a>00234             genCount+= toGenerate;  <span class="comment">// genCount: "assume" we generate exactly toGenerate</span>
<a name="l00235"></a>00235             <span class="keywordflow">for</span> (; begin!=it; ++begin)
<a name="l00236"></a>00236                 toGenerate-=
<a name="l00237"></a>00237                     bestDomainDensity( begin, level, toGenerate/(it-begin), zoom, results );
<a name="l00238"></a>00238             genCount-= toGenerate;  <span class="comment">// genCount: correct the count</span>
<a name="l00239"></a>00239         }
<a name="l00240"></a>00240         <span class="keywordflow">return</span> genCount;
<a name="l00241"></a>00241     }
<a name="l00242"></a>00242 }
<a name="l00243"></a><a class="code" href="classMStdDomains.html#eb9fd6d0f711c46ee0588f3b67deadf3">00243</a> vector&lt;short&gt; <a class="code" href="classMStdDomains.html#eb9fd6d0f711c46ee0588f3b67deadf3" title="Gets densities for all domain pools on a particular level (with size 2^level - zoomed)...">MStdDomains::getLevelDensities</a>(<span class="keywordtype">int</span> level,<span class="keywordtype">int</span> stdDomCountLog2) {
<a name="l00244"></a>00244     ASSERT(level&gt;=2);
<a name="l00245"></a>00245 <span class="comment">//  compute the sum of shares, check for no-domain situations</span>
<a name="l00246"></a>00246     <span class="keywordtype">int</span> totalShares= <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(DomPortion_Standard) + <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(DomPortion_Horiz)
<a name="l00247"></a>00247     + <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(DomPortion_Vert) + <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(DomPortion_Diamond);
<a name="l00248"></a>00248     stdDomCountLog2-= (level-<a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a>-2)*<a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(MaxDomCountLevelDivisor);
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <span class="keywordflow">if</span> ( <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.empty() || !totalShares || stdDomCountLog2&lt;0 )
<a name="l00251"></a>00251         <span class="keywordflow">return</span> vector&lt;short&gt;( <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.size(), 0 );
<a name="l00252"></a>00252 <span class="comment">//  get the real domain count for this level</span>
<a name="l00253"></a>00253     <span class="keywordtype">int</span> domCountLeft= powers[stdDomCountLog2];
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     vector&lt;short&gt; result;
<a name="l00256"></a>00256     result.reserve(<a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.size());
<a name="l00257"></a>00257     PoolList::iterator begin, end;
<a name="l00258"></a>00258     end= <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.begin();
<a name="l00259"></a>00259 <span class="comment">//  iterate over single-type domain-pool intervals</span>
<a name="l00260"></a>00260     <span class="keywordflow">while</span> ( end!=<a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.end() ) {
<a name="l00261"></a>00261         begin= end;
<a name="l00262"></a>00262     <span class="comment">//  find the end of the current interval</span>
<a name="l00263"></a>00263         <span class="keywordflow">while</span> ( end!=<a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.end() &amp;&amp; begin-&gt;type==end-&gt;type )
<a name="l00264"></a>00264             ++end;
<a name="l00265"></a>00265     <span class="comment">//  we've got a single-type interval</span>
<a name="l00266"></a>00266         <span class="keywordtype">int</span> share= <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>( (<a class="code" href="classMStdDomains.html#23abf4aa8f5dc4610081378feaf5c6e1" title="Indices for settings.">Settings</a>)begin-&gt;type );
<a name="l00267"></a>00267         domCountLeft-= <a class="code" href="classMStdDomains.html#a1bef878bf39ff0c3f013e926332f9c1" title="Generates (results.push_back) densities for domains on level level for all pools...">divideDomsInType</a>( begin, end, domCountLeft*share/totalShares
<a name="l00268"></a>00268             , level, <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(MultiDownScaling), <a class="code" href="classMStdDomains.html#d2b49e4aa2b04cae8362272cc3060576" title="the zoom">zoom</a>, result );
<a name="l00269"></a>00269         totalShares-= share;
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 <span class="comment">//  check we created the correct number of densities</span>
<a name="l00272"></a>00272     ASSERT( result.size() == <a class="code" href="classMStdDomains.html#35ae859bbb06a3fc9496e93e7a340bc9" title="The list of domain pools, pool IDs are the indices, the Pool::pixels are owned.">pools</a>.size() );
<a name="l00273"></a>00273     <span class="keywordflow">return</span> result;
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 
<a name="l00276"></a><a class="code" href="classMStdDomains.html#b73ce2703c774e8b9955f81c3ade7b0f">00276</a> <span class="keywordtype">void</span> <a class="code" href="classMStdDomains.html#b73ce2703c774e8b9955f81c3ade7b0f" title="Writes all settings (data needed for reconstruction that don&amp;#39;t depend on the...">MStdDomains::writeSettings</a>(ostream &amp;file) {
<a name="l00277"></a>00277     ASSERT( <span class="keyword">this</span> &amp;&amp; <a class="code" href="classModule.html#05a8665b709707811945fa29714c2e00" title="The current setting values of this Module.">settings</a> );
<a name="l00278"></a>00278 <span class="comment">//  all settings are small integers a need to be preserved</span>
<a name="l00279"></a>00279     <span class="keywordtype">int</span> setLength= <a class="code" href="classModule.html#987b1cfc57aae292f5375fbb88a4fd32" title="Returns reference to module-type&amp;#39;s information, like count and types of settings...">info</a>().<a class="code" href="structModule_1_1TypeInfo.html#6fabafddb7b1669d9cbb6b3996a8c4a9" title="The number of setting items.">setLength</a>;
<a name="l00280"></a>00280     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;setLength; ++i)
<a name="l00281"></a>00281         put&lt;Uchar&gt;( file, <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(i) );
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00284"></a><a class="code" href="classMStdDomains.html#09657e4e48d9f63e146bf93e0400d38c">00284</a> <span class="keywordtype">void</span> <a class="code" href="classMStdDomains.html#09657e4e48d9f63e146bf93e0400d38c" title="Reads all settings (like writeSettings).">MStdDomains::readSettings</a>(istream &amp;file) {
<a name="l00285"></a>00285     ASSERT( <span class="keyword">this</span> &amp;&amp; <a class="code" href="classModule.html#05a8665b709707811945fa29714c2e00" title="The current setting values of this Module.">settings</a> );
<a name="l00286"></a>00286 <span class="comment">//  all settings are small integers a need to be preserved</span>
<a name="l00287"></a>00287     <span class="keywordtype">int</span> setLength= <a class="code" href="classModule.html#987b1cfc57aae292f5375fbb88a4fd32" title="Returns reference to module-type&amp;#39;s information, like count and types of settings...">info</a>().<a class="code" href="structModule_1_1TypeInfo.html#6fabafddb7b1669d9cbb6b3996a8c4a9" title="The number of setting items.">setLength</a>;
<a name="l00288"></a>00288     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;setLength; ++i)
<a name="l00289"></a>00289         <a class="code" href="classModule.html#359731fdb1af95f2190e1031e1332515" title="A shortcut method for working with integer settings.">settingsInt</a>(i)= get&lt;Uchar&gt;(file);
<a name="l00290"></a>00290 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Thu Aug 6 22:33:14 2009 for Fractal Image Compressor by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.8 </small></address>
</body>
</html>
